---
title: "Single Covariate Model Selection for Scripps's Murrelet Linear Mixed Model"
author: "Amelia J. DuVall & Marcela Todd"
date: "5/16/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## load libraries
library(here)
library(tidyverse)
library(janitor)
library(ggplot2)
library(lubridate)
library(viridis)
library(lme4)
library(faraway)
library(sjPlot)
```

This is `r paste0("v.", (Sys.Date()))`

# Introduction
The covariates we selected to test the relationship between Scripps's Murrelet egg size and oceanographic conditions are collected at various temporal and spatial scales. In addition, the effects of some oceanographic conditions may take time to manifest in terms of prey availability for murrelets during the breeding season and other impacts that may affect egg size. Given the differences in spatial and temporal extent of oceanographic variables and their impacts on seabirds, we tested all environmental covariates for the Scripps's Murrelet egg size model (see SCMU_egg_model.Rmd) under four scenarios:
1. Monthly averages for January to June in year $t$ (6 months) to encompass only pre-breeding and laying season ("half")
2. Monthly averages for July in year $t-1$ to June in year $t$ (12 months) to encompass the entire post-breeding, pre-breeding, and breeding season ("full")
3. Monthly averages for January to June in year $t-1$ (6 months) to encompass only pre-breeding and laying season in the previous year ("half_lag")
4. Monthly averages for July in year $t-2$ to June in year $t-1$ (12 months) to encompass the entire post-breeding, pre-breeding, and breeding season in the previous year ("full_lag")

We tested 6 covariates: 
1. Larval anchovy (ANCHL) - This covariate is only available at a yearly sampling rate. Therefore, we tested this variable under two scenarios: 1) yearly value in time $t$, and 2) yearly value in time $t-1$. 
2. Biologically Effective Upwelling Transport Index (BEUTI)  
3. Sea Surface Temperature (SST)  
4. North Pacific Gyre Oscillation Index (NPGO)  
5. Pacific Decadal Oscillation Index (PDO)  
6. Oceanic Nino Index (ONI)  

See SCMU_egg_covariates.Rmd for more information on covariate sourcing.  

```{r df}
## load egg size data
egg <- read.csv(here("data", "SCMU_egg_data.csv"))%>%
  filter(TrueOrder == TRUE) %>% # egg order known only
  select(Year, Observer, Plot, Size, EggOrder)
```

# Environmental Covariates

## ANCHL
ANCHL sampling data is only available at a yearly sampling interval. 
```{r anchovyl}
## load data
ANCHLraw  <- read.csv(here("data", "covariates", "cciea_EI_FBS_2020_a29e_1fd0_409d.csv"), na.strings = "NaN")

## are there NAs in the data?
sum(is.na(ANCHLraw$relative_abundance))

## clean data 
ANCHL <- ANCHLraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time)) %>%
  mutate(ANCHL = as.numeric(relative_abundance)) %>%
  arrange(Year) %>%
  dplyr::select(Year, ANCHL) 

## create dataset from 2009-2017 for values in year t 
ANCHL_full <- ANCHL %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(ANCHL_full = scale(ANCHL)) %>%
  dplyr::select(Year, ANCHL_full)

## create dataset from 2008-2016 for values in year t-1 
ANCHL_full_lag <- ANCHL %>%
  filter(Year >= 2008 & Year <= 2016) %>%
  mutate(TrueYear = Year,
         Year = TrueYear + 1,
         ANCHL_full_lag = scale(ANCHL)) %>%
  dplyr::select(Year, ANCHL_full_lag)

## join no-lag and lag datasets
ANCHL1 <- full_join(ANCHL_full, ANCHL_full_lag, by = "Year")

## join with egg size data
ANCHLdf1 <- left_join(egg, ANCHL1, by = "Year")
  
## run models
ANCHL_full_mod <- lmer(Size ~ ANCHL_full + (1 | Plot), data = ANCHLdf1) 
ANCHL_full_lag_mod <- lmer(Size ~ ANCHL_full_lag + (1 | Plot), data = ANCHLdf1)

## compare AIC
ANCHL_full_AIC <- AIC(ANCHL_full_mod)
ANCHL_full_lag_AIC <- AIC(ANCHL_full_lag_mod)

## True or False, is the ANCHL no lag model AIC smaller than the ANCHL lag AIC?
ANCHL_full_AIC < ANCHL_full_lag_AIC

## What is the delta AIC?
ANCHL_full_lag_AIC - ANCHL_full_AIC
```
There is support to use the ANCHL data in year $t$ since the lagged data is delta AIC > 2. 

## BEUTI
```{r BEUTI1}
BEUTIraw <- read_csv(here("data", "covariates", "cciea_OC_BEUTI_784c_ef9f_af6f.csv"))

## are there NAs in the data?
sum(is.na(BEUTIraw$beuti))

## Scenario 1: "half" dataset from Jan-June in time t
BEUTI_half <- BEUTIraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(beuti = as.numeric(beuti)) %>%
  filter(Month == 1 | Month == 2 | Month == 3 |Month == 4 | Month == 5 | Month == 6) %>%
  group_by(Year) %>%
  summarise(BEUTI = mean(beuti, na.rm = TRUE)) %>%
  dplyr::select(Year, BEUTI) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(BEUTI_half = scale(BEUTI)) %>%
  arrange(Year) %>%
  dplyr::select(Year, BEUTI_half)

## Scenario 2: "full" dataset from July in time t-1 to June in time t
BEUTI_full <- BEUTIraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(beuti = as.numeric(beuti),
         split_year = ifelse(Month == 7 | Month == 8 | Month == 9 | Month == 10 | Month == 11 | Month == 12,
                             Year + 1, Year)) %>%
  rename(Year = split_year, true_year = Year) %>%
  group_by(Year) %>%
  summarise(BEUTI = mean(beuti, na.rm = TRUE)) %>%
  dplyr::select(Year, BEUTI) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(BEUTI_full = scale(BEUTI)) %>%
  arrange(Year) %>%
  dplyr::select(Year, BEUTI_full)

## Scenario 3: "half_lag" dataset from Jan-June in time t-1
BEUTI_half_lag <- BEUTIraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(beuti = as.numeric(beuti)) %>%
  filter(Month == 1 | Month == 2 | Month == 3 |Month == 4 | Month == 5 | Month == 6) %>%
  mutate(Year = Year + 1) %>%
  group_by(Year) %>%
  summarise(BEUTI = mean(beuti, na.rm = TRUE)) %>%
  dplyr::select(Year, BEUTI) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(BEUTI_half_lag = scale(BEUTI)) %>%
  arrange(Year) %>%
  dplyr::select(Year, BEUTI_half_lag)

## Scenario 4: "full_lag" dataset from July in time t-2 to June in time t-1
BEUTI_full_lag <- BEUTIraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(beuti = as.numeric(beuti),
         split_year = ifelse(Month == 7 | Month == 8 | Month == 9 | Month == 10 | Month == 11 | Month == 12,
                             Year + 1, Year)) %>%
  rename(Year = split_year, true_year = Year) %>%
  mutate(Year = Year + 1) %>%
  group_by(Year) %>%
  summarise(BEUTI = mean(beuti, na.rm = TRUE)) %>%
  dplyr::select(Year, BEUTI) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(BEUTI_full_lag = scale(BEUTI)) %>%
  arrange(Year) %>%
  dplyr::select(Year, BEUTI_full_lag)

## join datasets together
BEUTI1 <- full_join(BEUTI_half, BEUTI_full, by = "Year")
BEUTI2 <- full_join(BEUTI1, BEUTI_half_lag, by = "Year")
BEUTI3 <- full_join(BEUTI2, BEUTI_full_lag, by = "Year")

## join with egg size data
BEUTI_df <- left_join(egg, BEUTI3, by = "Year")
  
## run models
BEUTI_half_mod <- lmer(Size ~ BEUTI_half + (1 | Plot), data = BEUTI_df)
BEUTI_full_mod <- lmer(Size ~ BEUTI_full + (1 | Plot), data = BEUTI_df)
BEUTI_half_lag_mod <- lmer(Size ~ BEUTI_half_lag + (1 | Plot), data = BEUTI_df)
BEUTI_full_lag_mod <- lmer(Size ~ BEUTI_full_lag + (1 | Plot), data = BEUTI_df)

## Model selection table
BEUTI_AIC <- matrix(NA, nrow = 4, ncol = 3) # 4 rows for 6 top models
BEUTI_AIC[1,1] <- AIC(BEUTI_half_mod) 
BEUTI_AIC[2,1] <- AIC(BEUTI_full_mod) 
BEUTI_AIC[3,1] <- AIC(BEUTI_half_lag_mod)
BEUTI_AIC[4,1] <- AIC(BEUTI_full_lag_mod) 
BEUTI_AIC[,2] <- BEUTI_AIC[,1] - min(BEUTI_AIC[,1]) # calculate delta AIC
BEUTI_AIC[,3] <- exp(-0.5*BEUTI_AIC[,2])/(sum(exp(-0.5*BEUTI_AIC[,2]))) # calculate model weights
colnames(BEUTI_AIC) <- c("AIC", "deltaAIC", "model_weights")
rownames(BEUTI_AIC) <- c("half", "full", "half_lag", "full_lag")
print(BEUTI_AIC)
```

<!-- updated code up to here! -->

## SST
First, we tested against using data from the entire year versus from January-June. 
```{r sst1}
SSTraw <- read_csv(here("data", "covariates", "cciea_OC_SST3_91cf_d165_213f-46025.csv"))

## are there NAs in the data?
sum(is.na(SSTraw$SST))

## Averaged over all 12 months and scaled
SST_full <- SSTraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(sst = as.numeric(SST)) %>%
  group_by(Year) %>%
  summarise(SST = mean(sst, na.rm = TRUE)) %>%
  dplyr::select(Year, SST) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(SST_full = scale(SST)) %>%
  arrange(Year) %>%
  dplyr::select(Year, SST_full)

## Averaged for January-June only and scaled
SST_half <- SSTraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(sst = as.numeric(SST)) %>%
  filter(Month == 1 | Month == 2 | Month == 3 |Month == 4 | Month == 5 | Month == 6) %>% 
  group_by(Year) %>%
  summarise(SST = mean(sst, na.rm = TRUE)) %>%
  dplyr::select(Year, SST) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(SST_half = scale(SST)) %>%
  arrange(Year) %>%
  dplyr::select(Year, SST_half)

## join 2 datasets together
SST1 <- full_join(SST_full, SST_half, by = "Year")

## join with egg size data
SSTdf1 <- left_join(egg, SST1, by = "Year")

## run models
SST_full_mod <- lmer(Size ~ SST_full + (1 | Plot), data = SSTdf1) 
SST_half_mod <- lmer(Size ~ SST_half + (1 | Plot), data = SSTdf1)

## compare AIC
SST_full_AIC <- AIC(SST_full_mod)
SST_half_AIC <- AIC(SST_half_mod)

## True or False, is the Jan-Jun SST model AIC smaller than the SST full AIC?
SST_half_AIC < SST_full_AIC

## What is the delta AIC?
SST_half_AIC - SST_full_AIC
```
The full-year SST model has more support than the half-year model.

Then, using the top model, we tested a non-lagged versus one-year lagged dataset.
```{r SST2}
## no lag, averaged for 12 months (same as SST_full above) and scaled
SST_nolag <- SSTraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(sst = as.numeric(SST)) %>%
  group_by(Year) %>%
  summarise(SST = mean(sst, na.rm = TRUE)) %>%
  dplyr::select(Year, SST) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(SST_nolag = scale(SST)) %>%
  arrange(Year) %>%
  dplyr::select(Year, SST_nolag)

## one year lag, averaged for 12 months and scaled
SST_lag <- SSTraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(sst = as.numeric(SST)) %>%
  group_by(Year) %>%
  summarise(SST = mean(sst, na.rm = TRUE)) %>%
  dplyr::select(Year, SST) %>%
  filter(Year >= 2008 & Year <= 2016) %>%
  mutate(SST_lag = scale(SST),
         TrueYear = Year,
         Year = TrueYear + 1) %>%
  arrange(Year) %>%
  dplyr::select(Year, SST_lag)

## join 2 datasets together
SST2 <- full_join(SST_nolag, SST_lag, by = "Year")

## join with egg size data
SSTdf2 <- left_join(egg, SST2, by = "Year")
  
## run models
SST_nolag_mod <- lmer(Size ~ SST_nolag + (1 | Plot), data = SSTdf2) 
SST_lag_mod <- lmer(Size ~ SST_lag + (1 | Plot), data = SSTdf2)

## compare AIC
SST_nolag_AIC <- AIC(SST_nolag_mod)
SST_lag_AIC <- AIC(SST_lag_mod)

## True or False, is the no lag SST model AIC smaller than the SST lag AIC?
SST_nolag_AIC < SST_lag_AIC

## What is the delta AIC?
SST_lag_AIC - SST_nolag_AIC
```
The non-lagged SST data has more support than the one-year lagged SST data. There is support for a non-lagged SST data from the entire year (12 months). 

## NPGO
First, we tested three single covariate models: 1) data averaged from the entire year, 2) data averaged from January-June, and 3) data averaged from December-March (as supported by Chenillat et al. 2012, "the statistical relationship between NPGO index and nearshore wind variability (most upwelling favorable) along the U.S. West coast is strongest in the wintertime (December to March) off Central California"). 
```{r NPGO}
NPGOraw <- read_csv(here("data", "covariates", "cciea_OC_NPGO_712b_5843_9069.csv"))

## are there NAs in the data?
sum(is.na(NPGOraw$NPGO)) # only the first row, which does not contain data

## Averaged over all 12 months and scaled
NPGO_full <- NPGOraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time)) %>%
  mutate(npgo = as.numeric(NPGO)) %>%
  group_by(Year) %>%
  summarise(NPGO = mean(npgo, na.rm = TRUE)) %>%
  dplyr::select(Year, NPGO) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(NPGO_full = scale(NPGO)) %>%
  arrange(Year) %>%
  dplyr::select(Year, NPGO_full)

## Averaged for January-June only and scaled
NPGO_half <- NPGOraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(npgo = as.numeric(NPGO)) %>%
  filter(Month == 1 | Month == 2 | Month == 3 |Month == 4 | Month == 5 | Month == 6) %>% 
  group_by(Year) %>%
  summarise(NPGO = mean(npgo, na.rm = TRUE)) %>%
  dplyr::select(Year, NPGO) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(NPGO_half = scale(NPGO)) %>%
  arrange(Year) %>%
  dplyr::select(Year, NPGO_half)

## Averaged for December-March only and scaled
NPGO_delay <- NPGOraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(npgo = as.numeric(NPGO)) %>%
  filter(Month == 12 | Month == 1 | Month == 2 | Month == 3) %>%
  filter(Year >= 2008 & Year <= 2017)%>%
  slice(-c(1:3)) %>%
  slice(-37) %>%
  mutate(Period = c(rep("A", 4), rep("B", 4), rep("C", 4), rep("D", 4), 
                     rep("E", 4), rep("F", 4), rep("G", 4), rep("H", 4), rep("I", 4))) %>%
  group_by(Period) %>%
  summarise(NPGO = mean(npgo, na.rm = TRUE)) %>%
  mutate(Year = 2009:2017) %>%
  mutate(NPGO_delay = scale(NPGO)) %>%
  arrange(Year) %>%
  dplyr::select(Year, NPGO_delay)

## join 2 datasets together
NPGO1 <- full_join(NPGO_full, NPGO_half, by = "Year")
NPGO2 <- full_join(NPGO1, NPGO_delay, by = "Year")

## join with egg size data
NPGOdf1 <- left_join(egg, NPGO2, by = "Year")

## run models
NPGO_full_mod <- lmer(Size ~ NPGO_full + (1 | Plot), data = NPGOdf1) 
NPGO_half_mod <- lmer(Size ~ NPGO_half + (1 | Plot), data = NPGOdf1)
NPGO_delay_mod <- lmer(Size ~ NPGO_delay + (1 | Plot), data = NPGOdf1)

## compare AIC
NPGO_full_AIC <- AIC(NPGO_full_mod)
NPGO_half_AIC <- AIC(NPGO_half_mod)
NPGO_delay_AIC <- AIC(NPGO_delay_mod)

## True or False, is the full NPGO model AIC smaller than the half NPGO model AIC?
NPGO_full_AIC < NPGO_half_AIC

## What is the delta AIC?
NPGO_half_AIC - NPGO_full_AIC

## True or False, is the delay NPGO model AIC smaller than the full NPGO model AIC?
NPGO_delay_AIC < NPGO_full_AIC

## What is the delta AIC?
NPGO_delay_AIC - NPGO_full_AIC
```
The model that used all data from 12 months averaged for NPGO had the best fit. 

Then, using the full NPGO model, we tested a non-lagged versus one-year lagged dataset.
```{r NPGO2}
## no lag, data averaged for 12 months (same as NPGO_full above) and scaled
NPGO_nolag <- NPGOraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time)) %>%
  mutate(npgo = as.numeric(NPGO)) %>%
  group_by(Year) %>%
  summarise(NPGO = mean(npgo, na.rm = TRUE)) %>%
  dplyr::select(Year, NPGO) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(NPGO_nolag = scale(NPGO)) %>%
  arrange(Year) %>%
  dplyr::select(Year, NPGO_nolag)

## one year lag, data averaged for 12 months and scaled
NPGO_lag <- NPGOraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(npgo = as.numeric(NPGO)) %>%
  group_by(Year) %>%
  summarise(NPGO = mean(npgo, na.rm = TRUE)) %>%
  dplyr::select(Year, NPGO) %>%
  filter(Year >= 2008 & Year <= 2016) %>%
  mutate(NPGO_lag = scale(NPGO),
         TrueYear = Year,
         Year = TrueYear + 1) %>%
  arrange(Year) %>%
  dplyr::select(Year, NPGO_lag)

## join 2 datasets together
NPGO2 <- full_join(NPGO_nolag, NPGO_lag, by = "Year")

## join with egg size data
NPGOdf2 <- left_join(egg, NPGO2, by = "Year")
  
## run models
NPGO_nolag_mod <- lmer(Size ~ NPGO_nolag + (1 | Plot), data = NPGOdf2) 
NPGO_lag_mod <- lmer(Size ~ NPGO_lag + (1 | Plot), data = NPGOdf2)

## compare AIC
NPGO_nolag_AIC <- AIC(NPGO_nolag_mod)
NPGO_lag_AIC <- AIC(NPGO_lag_mod)

## True or False, is the no lag NPGO model AIC smaller than the NPGO lag AIC?
NPGO_nolag_AIC < NPGO_lag_AIC

## What is the delta AIC?
NPGO_lag_AIC - NPGO_nolag_AIC
```
The non-lagged NPGO data has more support than the one-year lagged data. There is the most support for a non-lagged NPGO data from the entire year (12 months). 

## PDO
First, we tested against using data from the entire year versus from January-June. 
```{r PDO1}
PDOraw <- read_csv(here("data", "covariates", "cciea_OC_PDO_712b_5843_9069.csv"))

## are there NAs in the data?
sum(is.na(PDOraw$PDO)) # only the first row, which does not contain data

## data averaged across entire year and scaled
PDO_full <- PDOraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time)) %>%
  mutate(pdo = as.numeric(PDO)) %>%
  group_by(Year) %>%
  summarise(PDO = mean(pdo, na.rm = TRUE)) %>%
  dplyr::select(Year, PDO) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(PDO_full = scale(PDO)) %>%
  arrange(Year) %>%
  dplyr::select(Year, PDO_full)

## data averaged for January-June only and scaled
PDO_half <- PDOraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(pdo = as.numeric(PDO)) %>%
  filter(Month == 1 | Month == 2 | Month == 3 |Month == 4 | Month == 5 | Month == 6) %>%
  group_by(Year) %>%
  summarise(PDO = mean(pdo, na.rm = TRUE)) %>%
  dplyr::select(Year, PDO) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(PDO_half= scale(PDO)) %>%
  arrange(Year) %>%
  dplyr::select(Year, PDO_half)

## join 2 datasets together
PDO1 <- full_join(PDO_full, PDO_half, by = "Year")

## join with egg size data
PDOdf1 <- left_join(egg, PDO1, by = "Year")

## run models
PDO_full_mod <- lmer(Size ~ PDO_full + (1 | Plot), data = PDOdf1) 
PDO_half_mod <- lmer(Size ~ PDO_half + (1 | Plot), data = PDOdf1)

## compare AIC
PDO_full_AIC <- AIC(PDO_full_mod)
PDO_half_AIC <- AIC(PDO_half_mod)

## True or False, is the Jan-Jun PDO model AIC smaller than the PDO full AIC?
PDO_half_AIC < PDO_full_AIC

## What is the delta AIC?
PDO_half_AIC - PDO_full_AIC
```
The full PDO model has more support than the half model. 

Then, using the full PDO model, we tested a non-lagged versus one-year lagged dataset.
```{r PDO2}
## no lag, averaged for 12 months (same as PDO_full above) and scaled
PDO_nolag <- PDOraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(pdo = as.numeric(PDO)) %>%
  group_by(Year) %>%
  summarise(PDO = mean(pdo, na.rm = TRUE)) %>%
  dplyr::select(Year, PDO) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(PDO_nolag = scale(PDO)) %>%
  arrange(Year) %>%
  dplyr::select(Year, PDO_nolag)

## one year lag, averaged for 12 months and scaled
PDO_lag <- PDOraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(pdo = as.numeric(PDO)) %>%
  group_by(Year) %>%
  summarise(PDO = mean(pdo, na.rm = TRUE)) %>%
  dplyr::select(Year, PDO) %>%
  filter(Year >= 2008 & Year <= 2016) %>%
  mutate(PDO_lag = scale(PDO),
         TrueYear = Year,
         Year = TrueYear + 1) %>%
  arrange(Year) %>%
  dplyr::select(Year, PDO_lag)

## join 2 datasets together
PDO2 <- full_join(PDO_nolag, PDO_lag, by = "Year")

## join with egg size data
PDOdf2 <- left_join(egg, PDO2, by = "Year")
  
## run models
PDO_nolag_mod <- lmer(Size ~ PDO_nolag + (1 | Plot), data = PDOdf2) 
PDO_lag_mod <- lmer(Size ~ PDO_lag + (1 | Plot), data = PDOdf2)

## compare AIC
PDO_nolag_AIC <- AIC(PDO_nolag_mod)
PDO_lag_AIC <- AIC(PDO_lag_mod)

## True or False, is the no lag PDO model AIC smaller than the PDO lag AIC?
PDO_nolag_AIC < PDO_lag_AIC

## What is the delta AIC?
PDO_nolag_AIC - PDO_lag_AIC
```
There is support for including a one-year lag for the PDO data averaged across 12 months.

## ONI
First, we tested against using data from the entire year versus from January-June. 
```{r ONI1}
ONIraw <- read_csv(here("data", "covariates", "cciea_OC_ONI_712b_5843_9069.csv"))

## are there NAs in the data?
sum(is.na(ONIraw$ONI)) # only the first row, which does not contain data

## data averaged across 12 months and scaled
ONI_full <- ONIraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time)) %>%
  mutate(oni = as.numeric(ONI)) %>%
  group_by(Year) %>%
  summarise(ONI = mean(oni, na.rm = TRUE)) %>%
  dplyr::select(Year, ONI) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(ONI_full = scale(ONI)) %>%
  arrange(Year) %>%
  dplyr::select(Year, ONI_full)

## data averaged for January-June only and scaled
ONI_half <- ONIraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(oni = as.numeric(ONI)) %>%
  filter(Month == 1 | Month == 2 | Month == 3 |Month == 4 | Month == 5 | Month == 6) %>%
  group_by(Year) %>%
  summarise(ONI = mean(oni, na.rm = TRUE)) %>%
  dplyr::select(Year, ONI) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(ONI_half = scale(ONI)) %>%
  arrange(Year) %>%
  dplyr::select(Year, ONI_half)

## join 2 datasets together
ONI1 <- full_join(ONI_full, ONI_half, by = "Year")

## join with egg size data
ONIdf1 <- left_join(egg, ONI1, by = "Year")

## run models
ONI_full_mod <- lmer(Size ~ ONI_full + (1 | Plot), data = ONIdf1) 
ONI_half_mod <- lmer(Size ~ ONI_half + (1 | Plot), data = ONIdf1)

## compare AIC
ONI_full_AIC <- AIC(ONI_full_mod)
ONI_half_AIC <- AIC(ONI_half_mod)

## True or False, is the Jan-Jun ONI model AIC smaller than the ONI full AIC?
ONI_half_AIC < ONI_full_AIC

## What is the delta AIC?
ONI_half_AIC - ONI_full_AIC
```
The full ONI model has more support than the half-year ONI model. 

Using the full ONI model, we tested a non-lagged versus one-year lagged dataset.
```{r ONI2}
## no lag, averaged for 12 months (same as ONI_full above) and scaled
ONI_nolag <- ONIraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(oni = as.numeric(ONI)) %>%
  group_by(Year) %>%
  summarise(ONI = mean(oni, na.rm = TRUE)) %>%
  dplyr::select(Year, ONI) %>%
  filter(Year >= 2009 & Year <= 2017) %>%
  mutate(ONI_nolag = scale(ONI)) %>%
  arrange(Year) %>%
  dplyr::select(Year, ONI_nolag)

## one year lag, averaged for 12 months and scaled
ONI_lag <- ONIraw %>%
  slice(-1) %>%
  mutate(time = ymd_hms(time)) %>%
  mutate(Year = year(time),
         Month = month(time)) %>%
  mutate(oni = as.numeric(ONI)) %>%
  group_by(Year) %>%
  summarise(ONI = mean(oni, na.rm = TRUE)) %>%
  dplyr::select(Year, ONI) %>%
  filter(Year >= 2008 & Year <= 2016) %>%
  mutate(ONI_lag = scale(ONI),
         TrueYear = Year,
         Year = TrueYear + 1) %>%
  arrange(Year) %>%
  dplyr::select(Year, ONI_lag) 

## join 2 datasets together
ONI2 <- full_join(ONI_nolag, ONI_lag, by = "Year")

## join with egg size data
ONIdf2 <- left_join(egg, ONI2, by = "Year")
  
## run models
ONI_nolag_mod <- lmer(Size ~ ONI_nolag + (1 | Plot), data = ONIdf2) 
ONI_lag_mod <- lmer(Size ~ ONI_lag + (1 | Plot), data = ONIdf2)

## compare AIC
ONI_nolag_AIC <- AIC(ONI_nolag_mod)
ONI_lag_AIC <- AIC(ONI_lag_mod)

## True or False, is the no lag ONI model AIC smaller than the ONI lag AIC?
ONI_nolag_AIC < ONI_lag_AIC

## What is the delta AIC?
ONI_lag_AIC - ONI_nolag_AIC
```
The no lag full ONI model has more support than the one-year lagged full ONI model. 
